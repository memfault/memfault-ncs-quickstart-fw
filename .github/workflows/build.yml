name: Build NCS Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/memfault/memfault-ncs-quickstart-fw:2025-11-04

    strategy:
      matrix:
        board:
          - nrf52840dk/nrf52840
          - nrf5340dk/nrf5340/cpuapp
          - thingy53/nrf5340/cpuapp
          - nrf54l15dk/nrf54l15/cpuapp
          - nrf54lm20dk/nrf54lm20a/cpuapp
          - nrf54h20dk/nrf54h20/cpuapp

      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Apply patches
      run: |
        git -C /opt/ncs/${MEMFAULT_NCS_VERSION}/nrf apply < patches/peripheral_mds.patch

    - name: Build firmware for ${{ matrix.board }}
      run: |
        . /opt/toolchain-env.sh
        cd /opt/ncs/${MEMFAULT_NCS_VERSION}
        west build --sysbuild --pristine=always --board ${{ matrix.board }} nrf/samples/bluetooth/peripheral_mds -- -DCONFIG_MEMFAULT_NCS_PROJECT_KEY=\"dummy\"

    - name: Create sanitized board name
      id: board_name
      run: |
        BOARD_NAME="${{ matrix.board }}"
        SANITIZED_NAME=$(echo "$BOARD_NAME" | sed 's/\//-/g')
        echo "sanitized=$SANITIZED_NAME" >> $GITHUB_OUTPUT

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-v0.0.1-${{ steps.board_name.outputs.sanitized }}-${{ github.sha }}
        path: |
          /opt/ncs/*/build/dfu_application.zip_manifest.json
          /opt/ncs/*/build/dfu_application.zip
          /opt/ncs/*/build/merged.hex
          /opt/ncs/*/build/peripheral_mds/zephyr/zephyr.elf
        retention-days: 30

    - name: Rebuild with version=0.0.2
      run: |
        . /opt/toolchain-env.sh
        cd /opt/ncs/${MEMFAULT_NCS_VERSION}
        west build --sysbuild --pristine=always --board ${{ matrix.board }} nrf/samples/bluetooth/peripheral_mds -- -DCONFIG_MEMFAULT_NCS_PROJECT_KEY=\"dummy\" -DCONFIG_MEMFAULT_NCS_FW_VERSION=\"0.0.2\"

    - name: Upload v0.0.2 build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-v0.0.2-${{ steps.board_name.outputs.sanitized }}-${{ github.sha }}
        path: |
          /opt/ncs/*/build/dfu_application.zip_manifest.json
          /opt/ncs/*/build/dfu_application.zip
          /opt/ncs/*/build/merged.hex
          /opt/ncs/*/build/peripheral_mds/zephyr/zephyr.elf
        retention-days: 30
